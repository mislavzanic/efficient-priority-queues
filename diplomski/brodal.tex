\newenvironment{myindentpar}[1]%
 {\begin{list}{}%
         {\setlength{\leftmargin}{#1}}%
         \item[]%
 }
 {\end{list}}

\chapter{Brodalov Queue}

Apstraktna struktura podataka prezentirana u ovom poglavlju zadovoljava asimptotske granice $O(1)$ za \texttt{FindMin}, \texttt{Meld}, \texttt{Insert} i \texttt{DecreaseKey}, te $O(\log n)$ za \texttt{DeleteMin}.
U poglavlju 3.3 opisujem pomo\'{c}nu strukturu podataka potrebnu za realizaciju nekih ograni\v{c}enja Brodalovog reda.

\section{Osnovna svojstva}

U ovom potpoglavlju navodimo invarijante koje struktura podataka treba zadovoljavati, a potom dajemo intuitivan opis invarijanti i dokaze nekih potrebnih tvrdnji.
No prvo, moramo dati opis Brodalovog reda kako bi \v{c}itatelju invarijante imale ikakvog smilsa.

Brodalov red definiramo kao skup od dva stabla $T_{1}$ i $T_{2}$.
Svi \v{c}vorovi stabla sadr\v{z}e vrijednost i prirodni broj koji \'{c}emo zvati rang.

Djeca \v{c}vora spremaju se u dvostruko vezanu listu.
Svaki \v{c}vor ima pokaziva\v{c} na roditelja i na najljevije dijete.

Intuitivno, $t_{1}$ (korijen stabla $T_{1}$) \'{c}e uvijek biti najmanji element. Zbog toga je vrijeme izvr\v{s}avanja \texttt{FindMin} iz $O(1)$.
Stablo $T_{2}$ je pomo\'{c}no stablo potrebno za odr\v{z}avanje pravila koja navodimo kasnije.

Tako\dj er, Brodalov red dopu\v{s}ta kr\v{s}enja tzv. \emph{min heap} svojstva.
Takve \v{c}vorove dalje navodimo kao \emph{lo\v{s}e} \v{c}vorove.
Kako je svaki lo\v{s} \v{c}vor, uz korijene stabla $T_{1}$ i $T_{2}$, kandidat za minimum, trebamo na\'{c}in za pratit takve \v{c}vorove.
To posti\v{z}emo sa tzv. $V$ i $W$ skupovima.
Svakom \v{c}voru $x$ Brodalovog reda pridru\v{z}ujemo njegove $W(x)$ i $V(x)$ skupove.
Intuicija iza $V$ i $W$ je sljede\'{c}a.
Svaki \v{c}vor koji ubacimo u red, a da on kr\v{s}i \emph{min heap} svojstvo ubacujemo u $V(t_{1})$ ili $W(t_{1})$.
Intuitivno, za neki \v{c}vor Brodalovog reda $x$ vrijedi $(\forall y \in W(x) \cup V(x))(y \ge x)$.
Zahtijevamo da $V(x) \cap W(x) = \emptyset$.
Skup $V$ je za \v{c}vorove ``ve\v{c}eg'' ranga, a $W$ za \v{c}vorove ``manjeg'' ranga.

$V$ i $W$ skupove tako\dj er implementiramo pomo\'{c}u dvostruko vezanih listi.
$V(x)$ i $W(x)$ implementiramo tako da svakom \v{c}voru $x$ dodajemo 4 pokaziva\v{c}a, dva na prve \v{c}vorove u svojoj $V(x)$ i $W(x)$ listi i dva na prethodni i sljede\'{c}i element u $V$ ili $W$ listi u kojoj se on sam nalazi (ako se, naravno, nalazi u jednoj).
Nove \v{c}vorove $V$ liste ubacijemo na po\v{c}etak liste, a nove \v{c}vorove $W$ liste ubacijemo tako da \v{c}vorovi istih rangova budu grupirani.\\
Dakle, ako prilikom dodavanja novog \v{c}vora u $W$ ve\'{c} postoji \v{c}vor istog ranga u $W$, novi \v{c}vor dodamo iza njega.
Ina\v{c}e, novi \v{c}vor gurnemo na po\v{c}etak ili kraj liste.
To je potrebno kako bi smo mogli odr\v{z}avati jednu od invarijanti opisanu u~\ref{O_inv}.
Ako \v{c}vor nekog ranga ne postoji u $W$, stavljamo \texttt{NULL} na to mjesto u nizu.

Dalje navodimo 3 vrste invarijanti.
Prva opisuje pridjeljivanje ranga \v{c}vorovima i tako utvr\dj uje strukturu stabla $T_{i}$.
Druga opisuje strukturu skupova $V$ i $W$.
Tre\'{c}a dodaje dodatna pravila na \v{c}vorove $t_{1}$ i $t_{2}$.

\begin{defn}[Invarijante \v{c}vorova]\label{S_inv}
  Neka je $x$ \v{c}vor Brodalovog reda. Tada za \v{c}vor x trebaju vrijediti sljede\'{c}e invarijante:
  \begin{myindentpar}{15pt}
    S1: Ako je $x$ list, onda je $r(x) = 0$, \\
    S2: $r(x) < r(p(x))$, \\
    S3: Ako $r(x) > 0$, onda $n_{r(x)-1}(x) \ge 2$, \\
    S4: $n_{i}(x) \in \{0,2,\ldots,7\}$, \\
    S5: $T_{2} = \emptyset $ ili $r(t_{1}) \le r(t_{2})$.
  \end{myindentpar}
\end{defn}

S1 i S2 ka\v{z}u da je rang lista jednak 0 i da rang \v{c}vora $x$ strogo raste prema korijenu.
S3 ka\v{z}e da \v{c}vor ranga $k > 0$ mora imat barem dvoje dijece ranga $k - 1$.
S5 ka\v{z}e da je $T_{2}$ prazno stablo, ili ima rang ve\v{c}i od $T_{1}$.
S4 ka\v{z}e da je broj djece ranga $i$ \v{c}vora $x$ konstantan i ne smije biti 1.
Ne dopu\v{s}tamo da broj \v{c}vorova stabla bude 1 kako bi i dalje vrijedila invarijanta S3 nakon \v{s}to odre\v{z}emo dijecu najve\v{c}eg ranga nekog \v{c}vora. $n_{i}(x) \le 7$ je posljedica konstrukcije koju kasnije obja\v{s}njavamo.

\begin{defn}[Invarijante strukture]\label{O_inv}
  Neka je $w_{i}(x)$ broj \v{c}vorova u $W(x)$ ranga $i$.
  \begin{myindentpar}{15pt}
    O1: $t_{1} = \min T_{1} \cup T_{2}$, \\
    O2: ako $y \in V(x) \cup W(x)$, onda $y \ge x$, \\
    O3: ako $y \le p(y)$, onda $\exists x \ne y$ tako da $y \in W(x) \cup V(x)$, \\
    O4: $w_{i}(x) \le 6$, \\
    O5: ako $V(x) = (y_{|V(x)| - 1},\dotsc,y_{1},y_{0})$, onda $r(y_{i}) \ge \lfloor\frac{i}{\alpha}\rfloor$, za $i = 0,1,\dotsc,|V(x)| - 1$, gdje je $\alpha$ konstanta.
  \end{myindentpar}
\end{defn}

O1 garantira da je $t_{1}$ minimalni element u redu.
O2 ka\v{z}e da \v{c}vorovi po\v{s}tuju \emph{min heap} svojstvo s obzirom na $V$ i $W$ skupove kojima pripadaju.
O3 ka\v{z}e da svi lo\v{s}i \v{c}vorovi pripadaju u $V$ ili $W$ skup.
O4 i O5 ka\v{z}u da su veli\v{c}ine $V$ i $W$ $O(\log n)$.
Micanjem \v{c}vorova iz $V$ ili $W$ ne kr\v{s}imo invarijante.

\begin{defn}[Invarijante korijena]\label{R_inv}
  Neka je x \v{c}vor Brodalovog reda. Tada za \v{c}vor x trebaju vrijediti sljede\'{c}e invarijante:
  \begin{myindentpar}{15pt}
    R1: $n_{i}(t_{j}) \in \{2,3,\dotsc,7\}$, za $i = 0,1,\dotsc,r(t_{j}) - 1$,\\
    R2: $|V(t_{1})| \le \alpha r(t_{1})$, \\
    R3: ako $y \in W(t_{1})$, onda $r(y) < r(t_{1})$.
  \end{myindentpar}
\end{defn}

R1 garantira da korijeni $t_{1}$ i $t_{2}$ imaju dijecu svakog ranga.
R2 ve\v{z}e veli\v{c}inu $V$ i $r(t_{1})$, pove\v{c}anjem $r(t_{1})$ dobivamo novih $\alpha$ mjesta u $V$.
R3 ka\v{z}e da lo\v{s}i \v{c}vorovi iz $W(t_{1})$ moraju imat rang manji od $r(t_{1})$.\\
Dalje dokazujemo neke od tvrdnji koje proizlaze iz gore navedenih pravila.
Iz S1 i S3 slijedi sljede\'{c}a lema.
One pokazuju vezu izme\dj u ranga \v{c}vora i veli\v{c}ine stabla.

\begin{lem}\label{Exp_cv}
  Neka je $x$ \v{c}vor nekog stabla $T$ koje zadovoljava S1 i S3. Podstablo sa korijenom $x$, ranga $r(x)$ ima barem $2^{r(x)+1} - 1$ \v{c}vorova.
\end{lem}
\begin{proof}
  Dokaz indukcijom po rangu \v{c}vora $x$.\\
  \emph{Baza}: $r(x) = 0$.\\
  \indent Iz S1 slijedi da je $x$ list, pa podstablo sa korijenom u $x$ ima $1 = 2^{0 + 1} - 1$ \v{c}vorova.\\
  \emph{Pretpostavka}: za \v{c}vor $x$ ranga $r(x) = n \in \N$ vrijedi tvrdnja.\\
  \emph{Korak}:\\
  \indent Neka je $x$ \v{c}vor ranga $r(x) = n+1$. Tada, po S3, slijedi da $x$ ima barem dvoje dijece ranga $n$. Tada podstablo sa korijenom u \v{c}voru $x$ ima barem $2(2^{k + 1} - 1)$ dijece iz \v{c}ega slijedi tvrdnja.
\end{proof}

\begin{lem}\label{Log_cv}
  Neka je $x$ \v{c}vor ranga $r(x)$ nekog stabla $T$ koje zadovoljava S1-S5 i neka je $n \in \N$ broj \v{c}vorova u $T$. Tada su rang i stupanj \v{c}vora $x$ $O(\log n)$.
\end{lem}
\begin{proof}
  Dovoljno je tvrdnju pokazat za korijen stabla $T$. Ozna\v{c}imo ga sa $t$.
  Iz S1-S4 slijedi da $n$ mo\v{z}emo ograni\'{c}iti odozgo sa $7^{r(t)} + 1$ i da se ta granica mo\v{z}e posti\'{c}i (svi \v{c}vorovi osim listova imaju po 7 djece svakog ranga manjeg od svog ranga).
  Iz toga slijedi $r(t) \in O(\log n)$, a iz toga i da je stupanj $t$ iz $O(\log n)$.
\end{proof}


Argumentirajmo jo\v{s} za\v{s}to O5 povla\'{c}i $|V(x)| \in O(\log n)$ za proizvoljan \v{c}vor Brodalovog reda.
To slijedi iz \v{c}injenice da je najve\v{c}i rang u Brodalovom redu iz $O(\log n)$.
Neka je $k \in \N$ najve\v{c}i rang nekog Brodalovog reda.
Tada vrijedi $k \ge \lfloor\frac{|V(x)| - 1}{\alpha}\rfloor$.\\
Sada mo\v{z}emo formalno definirati Brodalov red.
\begin{defn}[Brodalov red]
  Skup od dva stabla $T_{1}$ i $T_{2}$ koja zadovoljavaju invarijante iz~\ref{S_inv},~\ref{O_inv} i~\ref{R_inv} nazivamo Brodalovim redom.
\end{defn}

Op\'{c}enito, odr\v{z}avanje invarijanti O4 i R1 nije trivijalno ako \v{z}elimo imati $O(1)$ ubacivanje \v{c}vorova u stablo i izbacivanje \v{c}vorova iz stabla.
Zbog toga uvodimo pomo\'{c}nu strukturu podataka \emph{vodilju} (eng. \emph{guide}) koju opisujemo u~\ref{vodilja}.

\section{Vodilja}\label{vodilja}
U ovom dijelu opisujem pomo\v{c}nu apstraktnu strukturu podataka \emph{vodilju}.
Vodilje \'{c}e nam pomagati u odr\v{z}avanju invarijanti O4 iz~\ref{O_inv} i R1 iz~\ref{R_inv}.

Problem koji rije\v{s}avaju vodilje mo\v{z}e se opisati ovako.
Pretpostavimo da imamo niz cijelih brojeva $x_{n},\dotsc,x_{1}$ za koji \v{z}elimo da vrijedi $x_{i} \le T, i \in \{1,\dotsc,n\}$ za neku cjelobrojnu granicu $T$.
Jedinu operaciju koju na nizu $x_{n},\dotsc,x_{1}$ mo\v{z}emo izvoditi je operacija \texttt{reduce(i)} koja smanjuje $x_{i}$ za najmanje 2 i pove\'{c}ava $x_{i+1}$ za najvi\v{s}e 1.
Svaki se od $x_{i}$ mo\v{z}e ``prisilno'' pove\'{c}at, odnosno smanjiti za 1, ali za svaku takvu promijenu u nizu smijemo napraviti $O(1)$ \texttt{reduce} operacija kako bi odr\v{z}ali $x_{i} \le T$.
Funkcija vodilje je re\v{c}i koje \texttt{reduce} operacije izvesti.

Dalje opisujemo implementaciju vodilje.\\
Vodilji pridru\v{z}ujemo niz cijelih brojeva $\overline{x_{n}},\dotsc,\overline{x_{1}}$ takav da vrijedi $x_{i} \le \overline{x_{i}} \in \{T-2,T-1,T\}$.
Dokle god vrijedi $x_{i} \le \overline{x_{i}}$, ne trebamo pomo\'{c} vodilje.
Pomo\'{c} vodilje trebamo kada pove\'{c}avamo $x_{i} = \overline{x_{i}}$.
Npr. ako $\overline{x_{i}} = 6, x_{i} = 4$, tada $x_{i}$ mo\v{z}emo dva puta pove\'{c}ati bez da trebamo pomo\'{c} vodilje.\\
Primjetite da $x_{i}$ mo\v{z}emo proizvoljno smanjivati, tj. ako vrijedi $x_{i} \le \overline{x_{i}}$, onda sigurno vrijedi $x_{i} - 1 \le \overline{x_{i}}$.\\
U daljnjem opisivanju implementacije vodilje BSOMP da vrijedi $T = 2$, tj $\overline{x_{i}} \in \{0,1,2\}$ i da \texttt{reduce(i)} smanjuje $\overline{x_{i}}$ za 2 i pove\'{c}ava $\overline{x_{i+1}}$ za 1.\\
Niz $\overline{x_{n}},\dotsc,\overline{x_{1}}$ vodilje dijelimo u \emph{blokove} oblika $21^{\beta}0$, $\beta \in \N$.
Vodilja odr\v{z}ava invarijantu koja ka\v{z}e da broj 2 mora biti dio bloka, dok 1 i 0 ne moraju.
Broj 2 nazivamo vo\dj om bloka.
\begin{exa}
  Primjer nekog niza sa blokovima koji zadovoljava prethodno opisane uvijete.
  $$
  1,\underline{2,1,1,0},1,1,\underline{2,0},\underline{2,0},1,0,\underline{2,1,0},0.
  $$
\end{exa}
Za odr\v{z}avanje blokova koristimo dodatan niz pokaziva\'{c}a na pokaziva\'{c}e.
Elementi niza koji ne pripadaju niti jednom bloku imaju pridru\v{z}en $\bot$.
Elementi niza koji jesu u bloku imaju pokazuju na pokaziva\'{c} vo\dj e tog bloka.
Razlog tome je dvojak:
\begin{enumerate}
  \item Za bilo koji element niza mo\v{z}emo u $O(1)$ vremenu odrediti nalazi li se u bloku i, ako se nalazi u bloku, vo\dj u bloka u kojem se nalazi.
  \item U $O(1)$ vremenu uni\v{s}titi proizvoljan blok. Jednostavno pridru\v{z}imo $\bot$ bloku.
\end{enumerate}

Dalje opisujemo operaciju \texttt{reduce(i)}.\\
Razlikujemo nekoliko slu\v{c}ajeva:
\begin{enumerate}
  \item $d_{i+1} = 0$ i $d_{i+1}$ nije dio bloka. $d_{i+1} \leftarrow 1$ i uni\v{s}timo blok sa vo\dj om $d_{i}$.
  \item $d_{i+1} = 0$ i $d_{i+1}$ je dio bloka. $d_{i+1} \leftarrow 1$ i uni\v{s}timo blok sa vo\dj om $d_{i}$ i dodamo $d_{i}$ bloku u kojem je i $d_{i+1}$.
  \item $d_{i+1} = 1$. Uni\v{s}timo blok sa vo\dj om $d_{i}$, napravimo novi blok kojem je vo\dj a $d_{i+1}$ i dodamo mu $d_{i}$.
\end{enumerate}

Nakon opisane \texttt{reduce(i)} operacije, mo\v{z}emo opisati operaciju \texttt{forceIncrease(i)} kojom se izvr\v{s}ava ``prisilno'' pove\v{c}avanje $\overline{x_{i}}$.
Razlikujemo nekoliko slu\v{c}ajeva:
\begin{enumerate}
  \item $d_{i} = 0$ i $d_{i}$ nije dio bloka. $d_{i} \leftarrow 1$.
  \item $d_{i} = 0$ i $d_{i}$ je dio bloka. Napravi \texttt{reduce} na vo\dj i i $d_{i} \leftarrow 1$.
  \item $d_{i} = 1$ i $d_{i}$ nije dio bloka. $d_{i} \leftarrow 2$ i napravi \texttt{reduce(i)}.
  \item $d_{i} = 1$ i $d_{i}$ je dio bloka. Napravi \texttt{reduce} na vo\dj i tog bloka, $d_{i} \leftarrow 2$ i napravi \texttt{reduce(i)}.
\end{enumerate}

Iz gore navedenog je jasno da \emph{vodilja} u $O(1)$ u najgorem slu\v{c}aju mo\v{z}e odlu\v{c}iti koje \texttt{reduce} operacije izvesti.

\begin{exa}
  Jedan slu\v{c}aj operacije \texttt{forceIncrease}.
  \begin{center}
    \begin{tabular}{l}
      $\underline{2,1,1,0},\underline{2,1,1,1,0}$\\
      $\underline{2,1,1,0},\underline{2,2,1,1,0}$\qquad \texttt{forceIncrease(3)},\\
      $\underline{2,1,1,1},\underline{0,2,1,1,0}$\qquad \texttt{reduce(4)},\\
      $\underline{2,1,1,1},\underline{1,0,1,1,0}$\qquad \texttt{reduce(3)},\\
      $\underline{2,1,1,1,1,0},1,1,0$\qquad ponovno uspostavi blokove.\\
    \end{tabular}
  \end{center}
\end{exa}

\section{Operacije u stablu}

Nakon opisa strukture Brodalovog reda i vodilje mo\v{z}emo krenut opisivati operacije u stablima $T_{j}$ potrebne kako bi implementirali funkcije prioritetnog reda.

\subsection{Link i delink}\label{link_delink}

Dvije najosnovnije operacije u stablima su tzv. link i delink stabla.
Pretpostavimo da imamo 3 \v{c}vora $x_{1}, x_{2}, x_{3}$ jednakog ranga, i da niti jedan od njih nije $t_{i}$.
BSOMP da je $x_{1}$ najmanji po vrijednosti od njih, minimum mo\v{z}emo saznati rade\'{c}i najvi\v{s}e 2 usporedbe.
$x_{2}$ i $x_{3}$ mogu postati najljevija djeca $x_{1}$ i tako pove\'{c}ati rang od $x_{1}$ za 1.
Time su zadovoljene invarijante S1-S5 i O1-O5.

Primjetite da, iako smo rekli da niti jedan od 3 \v{c}vora u link operaciji ne smije biti $t_{i}$, nam operacija link daje odgovor na pitanje ``Kako dodati novi \v{c}vor u Brodalov red sa samo 2 \v{c}vora, a da sve invarijante vrijede?''.

Operacija delink je malo kompliciranija. Pretpostavimo da imamo neko stablo kojemu je korijen $x$. Razlikujemo dva slu\v{c}aja:
\begin{enumerate}
  \item $x$ ima dvoje ili troje djece ranga $r(x) - 1$. To dvoje/troje djece odre\v{z}emo i pridru\v{z}imo $x$ rang najljevijeg djeteta plus 1. S4 povla\'{c}i da S3 i dalje vrijedi (definicija~\ref{S_inv}).
  \item $x$ ima vi\v{s}e od troje djece ranga $r(x) - 1$. Dvoje djece odre\v{z}emo. $x$ i dalje ima rang $r(x)$. Sve invarijante i dalje vrijede.
\end{enumerate}
Delink stabla ranga $k$ uvijek rezultira sa dva ili 3 stabla ranga $k - 1$ i jednim stablom ranga manjeg ili jednakog $k$.

\subsection{Operacije na djeci korjena}\label{insert_cut}

Dalje opisujemo kako dodavati i micati djecu korijena, a da i dalje vrijedi R1 (definicija~\ref{R_inv}).
Za to su nam potrebne 4 vodilje, dvije za $t_{1}$ i dvije za $t_{2}$.
Dalje opisujemo postupak za $t_{1}$, konstrukcije za $t_{2}$ idu analogno.

Kako bi mogli izvr\v{s}iti link i delink operacije u $O(1)$ na djeci korjena proizvoljnog ranga potreban nam je niz pokaziva\v{c}a na dijete svakog ranga korijena $t_{1}$.
Zbog R1 (definicija~\ref{R_inv}) znamo da takva djeca postoje.

Spomenuli smo da $t_{1}$ ima dvije vodilje. Jedna vodilja odr\v{z}ava $n_{i}(t_{1}) \le 7$, a druga $n_{i}(t_{1}) \ge 2$ za $i = 0,\dotsc,r(t_{1}) - 3$.
Djecu ranga $r(t_{1}) - 1$ i $r(t_{1}) - 2$ izdvajamo i ru\v{c}no odr\v{z}avamo zbog me\dj usobne ovisnosti vodilje za gornju granicu i vodilje za donju granicu.
Ta ovisnost dolazi do izra\v{z}aja prilikom malog broja \v{c}vorova u stablu ili pove\v{c}avanja ranga stabla.\\
Brojevi sa kojima vodilja koja odr\v{z}ava gornju granicu broja djece su $\{5,6,7\}$, a $\{4,3,2\}$ su oni sa kojima raspola\v{z}e vodilja za donju granicu.

Dodavanje novog dijeteta ranga $k < r(t_{1}) - 2$ je ekvivalentno operaciji \texttt{forceIncrease(k)} na vodilji za gornju granicu.
Vodilja nam vrati koje \texttt{reduce} operacije trebamo napraviti kako bi obnovili invarijante.
\texttt{reduce(i)} operacija tu odgovara operaciji link na \v{c}vorovima ranga $i$, odnosno pove\v{c}a $n_{i+1}(t_{1})$ za 1 i smanji $n_{i}(t_{1})$ za 3.\\
Operaciju link radimo samo kada je $n_{i}(t_{1}) = 7$ kako nebi utjecali na vodilju za donju granicu (ipak smanjujemo za 3).
To implicira promjene u vodilji koju \v{c}emo opisati u~\ref{detalji_impl}.\\
Ako \texttt{reduce} pove\v{c}a broj djece ranga $r(t_{1}) - 2$ ili $r(t_{1}) - 1$, napravimo link operaciju na njima i mo\v{z}da pove\v{c}amo rang od $t_{1}$.

Micanje djece je sli\v{c}no, \texttt{reduce} operacija odgovara delink operaciji (po\v{s}to promatramo vodilju sa negativnom granicom $T$, pove\v{c}ati $\overline{x_{i}}$ za $k$ zna\v{c}i upravo odrezati mu $k$ djece).
Dodatno stablo nastalo kao rezultat delink operacije sa rangom $l \in {0,\dotsc,k}$ se dodaje zasebno, nakon operacije delink, kao dijete $t_{1}$ postupkom opisanim gore.

Situacija sa korijenom $t_{2}$ je sli\v{c}na.
Razlika je ta \v{s}to je $t_{1}$ \v{c}vor najmanje vrijednosti, dok $t_{2}$ mo\v{z}e imat proizvoljnu vrijednost.
Zbog te proizvoljne vrijednosti, gore opisane operacije mogu stvoriti nova kr\v{s}enja min heap svojstva koje nisu mogle nastat u $T_{1}$.
Linking nikad ne stvara lo\v{s}e \v{c}vorove, a delinking mo\v{z}e stvoriti najvi\v{s}e 3 nove lo\v{s}a \v{c}vora.
Lo\v{s}i \v{c}vorovi ranga ve\v{c}eg od $t_{1}$ su dodani u $V(t_{1})$. Kako bi O5 i R2 ostali zadovoljeni, trebamo garantirati da \'{c}e se rang $t_{1}$ pove\v{c}ati i da je $\alpha$ dovoljno velik.

\subsection{Operacije koje smanjuju broj lo\v{s}ih \v{c}vorova}\label{rm_los}

Dalje opisujemo operaciju s kojom mo\v{z}emo smanjiti broj \emph{potencijalnih lo\v{s}ih \v{c}vorova} iz $\bigcup_{y \in T_{1} \cup T_{2}}V(y) \cup W(y)$ za najmanje 1.

Pretpostavimo da postoje dva potencijalna lo\v{s}a \v{c}vora $x_{1}$ i $x_{2}$ jednakog ranga $k < r(t_{1})$ i da $x_{1}$ i $x_{2}$ nisu djeca korijena.
Prvo trebamo provjeriti jesu li $x_{1}$ i $x_{2}$ lo\v{s}i. Ako jedan od njih nije, maknemo ga iz skupa lo\v{s}ih \v{c}vorova kojem pripada.
Ako su oba lo\v{s}a, radimo sljede\'{c}e.
BSOMP da su $x_{1}$ i $x_{2}$ bra\'{c}a. S4 nam garantira da $x_{1}$ i $x_{2}$ oba imaju barem jednog brata.
Ako $x_{1}$ i $x_{2}$ slu\v{c}ajno nisu bra\'{c}a, uz pretpostavku $p(x_{1}) \le p(x_{2})$, mo\v{z}emo zamijeniti podstablo kojem je korijen $x_{1}$ sa podstablom kojem je korijen brat od $x_{2}$.
Tom zamijenom mo\v{z}emo samo smanjiti broj lo\v{s}ih \v{c}vorova (slijedi iz pretpostavke $p(x_{1}) \le p(x_{2})$ i \v{c}injenice da je $x_{1}$ lo\v{s}).

Neka je $y$ roditelj od $x_{1}$ i $x_{2}$.
Razlikujemo nekoliko slu\v{c}ajeva:
\begin{enumerate}
  \item $y$ ima vi\v{s}e od dvoje djece ranga $k$.
        $x_{1}$ mo\v{z}em odrezat i ododat kao dijete od $t_{1}$ postupkom opisanim u~\ref{insert_cut}.
  \item $y$ ima dvoje djece ranga $k$ i $r(y) > k+1$.
        Odre\v{z}emo $x_{1}$ i $x_{2}$ i u\v{c}inimo ih djecom $t_{1}$.
  \item $y$ ima dvoje djece ranga $k$ i $r(y) = k+1$.
        Odre\v{z}emo $x_{1}$, $x_{2}$ i $y$. Zamijenimo $y$ sa dijetetom od $t_{1}$ ranga $k+1$ kojeg mo\v{z}emo odrezati postupkom opisanim u~\ref{insert_cut}.
        Ako je $y$ dijete od $t_{1}$, odre\v{z}emo samo $y$.
        Ako zamjena za $y$ postane lo\v{s} \v{c}vor, dodamo ga u $W(t_{1})$.
        $x_{1}$, $x_{2}$ i $y$ u\v{c}inimo djecom $t_{1}$ postupkom opisanim u~\ref{insert_cut}.
\end{enumerate}

\subsection{Odr\v{z}avanje O4 i R2}

Dalje opisujemo kako o\v{c}uvati invarijante O4 i R2.
Jedini skupovi u koji dodajemo lo\v{s}e \v{c}vorove su $V(t_{1})$ i $W(t_{1})$ (\v{c}vorove ne mi\v{c}emo iz njih prilikom mijenjanja $t_{1}$).
Lo\v{s}i \v{c}vorovi ranga ve\v{c}eg od $r(t_{1})$ dodajemo u $V(t_{1})$, a ina\v{c}e ih dodajemo u $W(t_{1})$.
\v{C}vorove iz $W(t_{1})$ kontrolira vodilja (vodilja odr\v{z}ava O4), a \v{c}vorove iz $V(t_{1})$ kontroliramo ru\v{c}no.

Nakon dodavanja \v{c}vora u $W(t_{1})$ radimo operacije koje nam vodilja ka\v{z}e da napravimo.
\texttt{reduce(i)} operacija ovdje odgovara operaciji opisanoj u~\ref{rm_los}.
\texttt{reduce(i)} operaciju izvr\v{s}avamo ako je broj lo\v{s}ih \v{c}vorova u $W(t_{1})$ ranga $i$ jednak 6 i barem 2 ta \v{c}vora nisu direktna djeca od $t_{2}$.
Ako ih je vi\v{s}e od 4, odre\v{z}emo 2 \v{c}vora iz $W(t_{1})$ i u\v{c}inimo ih dobrom djecom od $t_{1}$
Ne moramo se brinuti o vodilji za donju granicu zato \v{s}to postoje jo\v{s} 4 \v{c}vora ranga $i$ koji su djeca od $t_{2}$ (znamo zato \v{s}to su u $W(t_{1})$).

R2 odr\v{z}avamo tako da pove\v{c}avamo rang od $t_{1}$ nakon svake operacije prioritetnog reda koju napravimo.
To radimo tako da mi\v{c}emo konstantan broj djece od $t_{2}$ u $t_{1}$.
Ako je $T_{2} = \emptyset$ pravilo $R2$ je trivijalno zadovoljeno jer je $V(t_{1}) = \emptyset$.
Pretpostavimo $T_{2} \ne \emptyset$.
Razlikujemo dva slu\v{c}aja:
\begin{enumerate}
  \item $r(t_{2}) \le r(t_{1}) + 1$.
        Odre\v{z}emo djecu $t_{2}$ najve\v{c}eg ranga i dodamo ih pod $t_{1}$.
        Nakon toga dodamo $t_{2}$ pod $t_{1}$.
  \item $r(t_{2}) > r(t_{1}) + 1$.
        Odre\v{z}emo djete $t_{2}$ ranga $r(t_{1}) + 1$.
        Nakon toga napravimo operaciju delink nad tim \v{c}vorom i rezultiraju\v{c}a stabla dodamo pod $t_{1}$.
\end{enumerate}
Ovim se postupkom $r(t_{1})$ pove\v{c}a za najmanje 1.

\section{Operacije prioritetnog reda}\label{impl}

\section{Detalji implementacije}\label{detalji_impl}

U ovom dijelu detaljnije opisujemo implementaciju i napominjemo neke detalje koje smo ispustili, a bitni su.
